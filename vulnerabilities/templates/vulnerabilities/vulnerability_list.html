<!-- vulnerabilities/templates/vulnerabilities/vulnerability_list.html -->

{% extends 'vulnerabilities/base.html' %}

{% block title %}漏洞列表 - 漏洞追踪系统{% endblock %}

{% block content %}
<h2>漏洞列表</h2>

<!-- 搜索和过滤表单 -->
<form method="get" class="form-inline mb-3">
    <!-- 搜索框 -->
    <div class="form-group mr-2">
        <input type="text" name="q" class="form-control" style="width: 240px;" placeholder="搜索Key/CVE/标题/描述..." value="{{ query }}">
    </div>
    
    <!-- 严重性过滤下拉菜单 -->
    <div class="form-group mr-2">
        <select name="severity" class="form-control">
            <option value="">所有严重性</option>
            {% for key, value in severity_choices %}
                <option value="{{ key }}" {% if severity_filter == key %}selected{% endif %}>{{ value }}</option>
            {% endfor %}
        </select>
    </div>
    
    <!-- 搜索按钮 -->
    <button type="submit" class="btn btn-primary">搜索</button>
    
    <!-- 重置按钮，仅在有搜索条件时显示 -->
    {% if query or severity_filter %}
        <a href="{% url 'vulnerabilities:vulnerability_list' %}" class="btn btn-secondary ml-2">重置</a>
    {% endif %}
</form>


<div class="table-responsive">
    <table class="table table-striped">
        <thead>
            <tr>
                <th style="width: 5%">编号</th>
                <th style="width: 15%">Key</th>
                <th style="width: 12%">CVE</th>
                <th style="width: 30%">标题</th>
                <th style="width: 8%">严重性</th>
                <th style="width: 15%">披露时间</th>
                <th style="width: 15%">操作</th>
            </tr>
        </thead>
        <tbody>
            {% for vuln in vulnerabilities %}
                <tr>
                    <td>{{ vuln.id }}</td>
                    <td class="text-break">{{ vuln.key }}</td>
                    <td>{{ vuln.cve|default:"-" }}</td>
                    <td class="text-break">{{ vuln.title }}</td>
                    <td>{{ vuln.severity }}</td>
                    <td>{{ vuln.disclosure|date:"Y-m-d"|default:"-" }}</td>
                    <td>
                        <a href="{% url 'vulnerabilities:vulnerability_detail' vuln.id %}" class="btn btn-info btn-sm">查看详情</a>
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="7">没有找到漏洞信息。</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- 分页控件 -->
<!-- 分页控件 -->
<nav aria-label="页面导航">
    <ul class="pagination justify-content-center">
        <!-- 首页和上一页 -->
        <li class="page-item {% if not vulnerabilities.has_previous %}disabled{% endif %}">
            <a class="page-link" href="?page=1{% if query %}&q={{ query|urlencode }}{% endif %}{% if severity_filter %}&severity={{ severity_filter }}{% endif %}" aria-label="首页">
                <span aria-hidden="true">&laquo;</span>
            </a>
        </li>

        <!-- 页码显示 -->
        {% with ''|center:vulnerabilities.paginator.num_pages as range %}
        {% for _ in range %}
            {% with forloop.counter as page_num %}
                {% if page_num == vulnerabilities.number %}
                    <li class="page-item active">
                        <span class="page-link">{{ page_num }}</span>
                    </li>
                {% elif page_num > vulnerabilities.number|add:"-3" and page_num < vulnerabilities.number|add:"3" %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_num }}{% if query %}&q={{ query|urlencode }}{% endif %}{% if severity_filter %}&severity={{ severity_filter }}{% endif %}">{{ page_num }}</a>
                    </li>
                {% elif page_num == 1 or page_num == vulnerabilities.paginator.num_pages %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_num }}{% if query %}&q={{ query|urlencode }}{% endif %}{% if severity_filter %}&severity={{ severity_filter }}{% endif %}">{{ page_num }}</a>
                    </li>
                {% elif page_num == vulnerabilities.number|add:"-3" or page_num == vulnerabilities.number|add:"3" %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                {% endif %}
            {% endwith %}
        {% endfor %}
        {% endwith %}

        <!-- 末页和下一页 -->
        <li class="page-item {% if not vulnerabilities.has_next %}disabled{% endif %}">
            <a class="page-link" href="?page={{ vulnerabilities.paginator.num_pages }}{% if query %}&q={{ query|urlencode }}{% endif %}{% if severity_filter %}&severity={{ severity_filter }}{% endif %}" aria-label="末页">
                <span aria-hidden="true">&raquo;</span>
            </a>
        </li>
    </ul>
</nav>
{% endblock %}