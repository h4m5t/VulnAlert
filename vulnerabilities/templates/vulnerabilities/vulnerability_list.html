<!-- vulnerabilities/templates/vulnerabilities/vulnerability_list.html -->

{% extends 'vulnerabilities/base.html' %}

{% block title %}漏洞列表 - 漏洞追踪系统{% endblock %}

{% block content %}
<h2>漏洞列表</h2>

<!-- 搜索和过滤表单 -->
<form method="get" class="form-inline mb-3">
    <!-- 搜索框 -->
    <div class="form-group mr-2">
        <input type="text" name="q" class="form-control" style="width: 240px;" placeholder="搜索Key/CVE/标题/描述..." value="{{ query }}">
    </div>
    
    <!-- 严重性过滤下拉菜单 -->
    <div class="form-group mr-2">
        <select name="severity" class="form-control">
            <option value="">所有严重性</option>
            {% for key, value in severity_choices %}
                <option value="{{ key }}" {% if severity_filter == key %}selected{% endif %}>{{ value }}</option>
            {% endfor %}
        </select>
    </div>
        
    <!-- 推送状态过滤下拉菜单 -->
    <div class="form-group mr-2">
        <select name="pushed" class="form-control">
            <option value="">所有推送状态</option>
            <option value="1" {% if pushed_filter == "1" or pushed_filter|lower == "已推送" %}selected{% endif %}>已推送</option>
            <option value="0" {% if pushed_filter == "0" or pushed_filter|lower == "未推送" %}selected{% endif %}>未推送</option>
        </select>
    </div>

    <!-- 搜索按钮 -->
    <button type="submit" class="btn btn-primary">搜索</button>
    
    <!-- 重置按钮，仅在有搜索条件时显示 -->
    {% if query or severity_filter or pushed_filter %}
        <a href="{% url 'vulnerabilities:vulnerability_list' %}" class="btn btn-secondary ml-2">重置</a>
    {% endif %}
</form>


<div class="table-responsive">
    <table class="table table-striped">
        <thead>
            <tr>
                <th style="width: 5%">编号</th>
                <th style="width: 10%">Key</th>
                <th style="width: 15%">CVE</th>
                <th style="width: 25%">标题</th>
                <th style="width: 8%">严重性</th>
                <th style="width: 15%">披露时间</th>
                <th style="width: 9%">推送状态</th> <!-- 新增推送状态列 -->
                <th style="width: 18%">操作</th>
            </tr>
        </thead>
        <tbody>
            {% for vuln in vulnerabilities %}
                <tr>
                    <td>{{ vuln.id }}</td>
                    <td class="text-break">{{ vuln.key }}</td>
                    <td>{{ vuln.cve|default:"-" }}</td>
                    <td class="text-break">{{ vuln.title }}</td>
                    <td>{{ vuln.severity }}</td>
                    <td>{{ vuln.disclosure|date:"Y-m-d"|default:"-" }}</td>
                    <td>
                        {% if vuln.pushed %}
                            <span class="badge badge-success">已推送</span>
                        {% else %}
                            <span class="badge badge-secondary">未推送</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{% url 'vulnerabilities:vulnerability_detail' vuln.id %}" class="btn btn-info btn-sm">查看详情</a>
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="8">没有找到漏洞信息。</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- 分页控件 -->
<nav aria-label="页面导航">
    <ul class="pagination justify-content-center">
        <!-- 首页和上一页 -->
        <li class="page-item {% if not vulnerabilities.has_previous %}disabled{% endif %}">
            <a class="page-link" href="?page=1{% if query %}&q={{ query|urlencode }}{% endif %}{% if severity_filter %}&severity={{ severity_filter }}{% endif %}{% if pushed_filter %}&pushed={{ pushed_filter }}{% endif %}" aria-label="首页">
                <span aria-hidden="true">&laquo;</span>
            </a>
        </li>

        <!-- 页码显示 -->
        {% for num in vulnerabilities.paginator.page_range %}
            {% if vulnerabilities.number == num %}
                <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                </li>
            {% elif num > vulnerabilities.number|add:"-3" and num < vulnerabilities.number|add:"3" %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% if query %}&q={{ query|urlencode }}{% endif %}{% if severity_filter %}&severity={{ severity_filter }}{% endif %}{% if pushed_filter %}&pushed={{ pushed_filter }}{% endif %}">{{ num }}</a>
                </li>
            {% elif num == 1 or num == vulnerabilities.paginator.num_pages %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% if query %}&q={{ query|urlencode }}{% endif %}{% if severity_filter %}&severity={{ severity_filter }}{% endif %}{% if pushed_filter %}&pushed={{ pushed_filter }}{% endif %}">{{ num }}</a>
                </li>
            {% elif num == vulnerabilities.number|add:"-3" or num == vulnerabilities.number|add:"3" %}
                <li class="page-item disabled">
                    <span class="page-link">...</span>
                </li>
            {% endif %}
        {% endfor %}

        <!-- 末页和下一页 -->
        <li class="page-item {% if not vulnerabilities.has_next %}disabled{% endif %}">
            <a class="page-link" href="?page={{ vulnerabilities.paginator.num_pages }}{% if query %}&q={{ query|urlencode }}{% endif %}{% if severity_filter %}&severity={{ severity_filter }}{% endif %}{% if pushed_filter %}&pushed={{ pushed_filter }}{% endif %}" aria-label="末页">
                <span aria-hidden="true">&raquo;</span>
            </a>
        </li>
    </ul>
</nav>
{% endblock %}